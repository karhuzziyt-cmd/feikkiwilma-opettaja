<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wilma</title>
    <style>
        :root {
            --wilma-blue: #003366;
            --text-gray: #8e8e93;
            --border-light: #e5e5ea;
            --detail-bg: #f2f2f7;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: #ffffff;
            margin: 0;
            padding-bottom: 80px;
            -webkit-tap-highlight-color: transparent;
        }

        /* ETUSIVUN YL√ÑOSA */
        .header {
            background-color: var(--wilma-blue);
            color: white;
            padding: 20px 15px 40px;
            text-align: center;
        }

        .profile-icon {
            width: 80px; height: 80px;
            background: white; border-radius: 50%;
            margin: 0 auto 10px;
            display: flex; align-items: center; justify-content: center;
        }

        .profile-name { font-size: 18px; font-weight: 500; }

        /* ETUSIVUN KORTIT */
        .container { padding: 0 15px; }
        .section-title { color: var(--text-gray); font-size: 12px; margin: 25px 0 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .notes-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        .note-card {
            background: white; border: 1px solid var(--border-light);
            border-radius: 12px; padding: 12px;
            border-left: 6px solid; cursor: pointer;
            display: flex; flex-direction: column; justify-content: space-between;
            min-height: 90px;
        }

        .note-reason { font-weight: bold; font-size: 15px; margin-bottom: 2px; }
        .note-sub { font-size: 13px; color: var(--text-gray); line-height: 1.2; }

        /* YKSITYISKOHTAINEN N√ÑKYM√Ñ */
        #detailPage {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--detail-bg); z-index: 1000;
            display: none; overflow-y: auto;
        }

        .detail-header { background: var(--wilma-blue); color: white; padding: 15px; font-size: 24px; }
        
        .detail-content { padding: 20px; text-align: center; }
        .detail-circle { width: 55px; height: 55px; border-radius: 50%; margin: 0 auto 10px; }
        .detail-title { font-size: 20px; font-weight: bold; margin-bottom: 5px; color: #000; }
        .detail-date { color: #007aff; font-size: 15px; margin-bottom: 25px; font-weight: 500; }

        .info-group { text-align: left; margin-bottom: 20px; }
        .info-label { font-size: 12px; color: var(--text-gray); text-transform: uppercase; font-weight: 600; margin-left: 5px; margin-bottom: 5px; display: block; }
        .info-box { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; font-size: 15px; color: #333; }

        /* ALAPALKKI */
        .footer-nav {
            position: fixed; bottom: 0; width: 100%; background: #f9f9f9;
            display: flex; border-top: 1px solid #ddd; padding: 10px 0; z-index: 100;
        }
        .nav-item { flex: 1; text-align: center; font-size: 10px; color: var(--text-gray); }
        .nav-item.active { color: var(--wilma-blue); font-weight: bold; }
    </style>
</head>
<body>

    <div id="mainPage">
        <div class="header">
            <div class="profile-icon">
                <img src="https://cdn-icons-png.flaticon.com/512/1077/1077114.png" width="50" style="opacity:0.8">
            </div>
            <div id="userName" class="profile-name">Ladataan...</div>
        </div>
        <div class="container">
            <div class="section-title">Lesson Notes</div>
            <div id="notesGrid" class="notes-grid"></div>
        </div>
    </div>

    <div id="detailPage">
        <div class="detail-header">
            <span style="cursor:pointer" onclick="closeDetails()">‚Äπ</span>
        </div>
        <div class="detail-content">
            <div id="detCircle" class="detail-circle"></div>
            <div id="detReason" class="detail-title"></div>
            <div id="detDate" class="detail-date"></div>

            <div class="info-group">
                <span class="info-label">Group</span>
                <div class="info-box" id="detGroup"></div>
            </div>

            <div class="info-group">
                <span class="info-label">Teacher</span>
                <div class="info-box" id="detTeacher"></div>
            </div>

            <div class="info-group">
                <span class="info-label">Comments</span>
                <div class="info-box" id="detComment"></div>
            </div>
            
            <div class="info-group">
                <span class="info-label">Duration</span>
                <div class="info-box" id="detDuration">45</div>
            </div>
        </div>
    </div>

    <div class="footer-nav">
        <div class="nav-item active">üè†<br>Home</div>
        <div class="nav-item">üí¨<br>Messages</div>
        <div class="nav-item">üïí<br>Schedule</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBnBxP9nN_z1nFB_bD4pgbG4W-uwnyN-jk",
            authDomain: "wilma-feikki.firebaseapp.com",
            projectId: "wilma-feikki",
            storageBucket: "wilma-feikki.firebasestorage.app",
            messagingSenderId: "536302104544",
            appId: "1:536302104544:web:41526cb87af29f98790585"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Funktio yksityiskohtien avaamiseen
        window.openDetails = (data) => {
            const dateObj = data.date ? data.date.toDate() : new Date();
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const dateStr = `${days[dateObj.getDay()]} ${dateObj.toLocaleDateString('fi-FI')} ${dateObj.toLocaleTimeString('fi-FI', {hour:'2-digit', minute:'2-digit'})}`;

            document.getElementById('detReason').innerText = data.reason;
            document.getElementById('detCircle').style.backgroundColor = data.color;
            document.getElementById('detGroup').innerText = data.subject || "Matematiikka";
            document.getElementById('detTeacher').innerText = data.teacher;
            document.getElementById('detComment').innerText = data.comment || "";
            document.getElementById('detDate').innerText = dateStr;
            document.getElementById('detDuration').innerText = data.duration || "45";
            
            document.getElementById('detailPage').style.display = "block";
            window.scrollTo(0, 0);
        };

        window.closeDetails = () => {
            document.getElementById('detailPage').style.display = "none";
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // DYNAAMINEN NIMI: K√§ytet√§√§n Google-tilin nime√§
                document.getElementById('userName').innerText = user.displayName || user.email.split('@')[0];

                const q = query(collection(db, "merkinnat"), where("targetEmail", "==", user.email.toLowerCase().trim()));
                
                onSnapshot(q, (snap) => {
                    const grid = document.getElementById('notesGrid');
                    grid.innerHTML = "";
                    snap.forEach(doc => {
                        const n = doc.data();
                        const card = document.createElement('div');
                        card.className = 'note-card';
                        card.style.borderLeftColor = n.color;
                        card.onclick = () => openDetails(n);
                        card.innerHTML = `
                            <div>
                                <div class="note-reason">${n.reason}</div>
                                <div class="note-sub">${n.teacher}</div>
                                <div class="note-sub" style="font-size:11px">${n.subject}</div>
                            </div>
                        `;
                        grid.appendChild(card);
                    });
                });
            } else {
                signInWithPopup(auth, new GoogleAuthProvider());
            }
        });
    </script>
</body>
</html>
